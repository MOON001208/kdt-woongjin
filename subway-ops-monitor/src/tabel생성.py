import psycopg2
from config import Config
from urllib.parse import urlparse
import sys

def create_subway_table():
    """
    Supabase DBì— realtime_subway_positions í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
    """
    conn = None
    cur = None
    
    # 1. í™˜ê²½ë³€ìˆ˜ ë° ì„¤ì • í™•ì¸
    try:
        Config.check_config()
        if not Config.DATABASE_URL:
            print("âŒ DATABASE_URL í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            return
    except ValueError as e:
        print(f"âŒ ì„¤ì • ì˜¤ë¥˜: {e}")
        return

    # 2. DB ì—°ê²° ì‹œë„
    try:
        dsn = Config.DATABASE_URL
        parsed = urlparse(dsn)
        # ë¹„ë°€ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬í•˜ì—¬ ì¶œë ¥
        masked_dsn = dsn.replace(parsed.password, "******") if parsed.password else dsn
        print(f"ğŸ”Œ ì—°ê²° ì •ë³´: {masked_dsn}")
        
        print("â³ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²° ì¤‘... (ì‘ë‹µì´ ì—†ìœ¼ë©´ ì—”í„°ë¥¼ ì³ë³´ì„¸ìš”)")
        conn = psycopg2.connect(dsn, connect_timeout=10)
        cur = conn.cursor()
        
        # 3. í…Œì´ë¸” ìƒì„± ì¿¼ë¦¬ (AGENT.md ë° docs/schema.sql ì°¸ê³ )
        # - direction_type, is_express: ë°ì´í„° íƒ€ì… ì •í•©ì„±ì„ ìœ„í•´ INTEGER ì‚¬ìš©
        # - is_last_train: BOOLEAN ì‚¬ìš©
        create_query = """
        CREATE TABLE IF NOT EXISTS realtime_subway_positions (
            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            
            -- API ì›ë³¸ ë°ì´í„° ë§¤í•‘
            line_id VARCHAR(50),          -- subwayId
            line_name VARCHAR(50),        -- subwayNm
            station_id VARCHAR(50),       -- statnId
            station_name VARCHAR(100),    -- statnNm
            train_number VARCHAR(50),     -- trainNo
            last_rec_date VARCHAR(20),    -- lastRecptnDt
            last_rec_time VARCHAR(20),    -- recptnDt
            direction_type INTEGER,       -- updnLine (0/1)
            dest_station_id VARCHAR(50),  -- statnTid
            dest_station_name VARCHAR(100),-- statnTnm
            train_status VARCHAR(50),     -- trainSttus
            is_express INTEGER,           -- directAt (0/1/7)
            is_last_train BOOLEAN,        -- lstcarAt (0/1 -> T/F)
            
            created_at TIMESTAMPTZ DEFAULT NOW()
        );
        
        -- ì¸ë±ìŠ¤ ìƒì„± (ì¡°íšŒ ì„±ëŠ¥ ìµœì í™”)
        CREATE INDEX IF NOT EXISTS idx_subway_positions_created_at ON realtime_subway_positions(created_at);
        CREATE INDEX IF NOT EXISTS idx_subway_positions_line_id ON realtime_subway_positions(line_id);
        """
        
        # 4. ì¿¼ë¦¬ ì‹¤í–‰
        cur.execute(create_query)
        conn.commit()
        
        print("âœ… í…Œì´ë¸” 'realtime_subway_positions' ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        
    except psycopg2.OperationalError as e:
        print(f"\nâŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {e}")
        print("="*60)
        print("ğŸ’¡ [íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ]")
        print("1. 'could not translate host name' ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²½ìš°:")
        print("   -> í˜„ì¬ ë„¤íŠ¸ì›Œí¬ê°€ IPv6ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ Supabase Direct URLì— ì ‘ì†í•˜ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        print("   -> Supabase Dashboard > Project Settings > Database > Connection Pooling ì—ì„œ")
        print("      'Connection Pooler (IPv4)' URLì„ ë³µì‚¬í•˜ì—¬ .envì˜ DATABASE_URLì„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.")
        print("      (ì˜ˆ: postgresql://postgres.[project]:[pwd]@aws-0-[region].pooler.supabase.com:6543/postgres)")
        print("2. 'password authentication failed' ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²½ìš°:")
        print("   -> .env íŒŒì¼ì˜ DB ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”.")
        print("="*60)
        
    except Exception as e:
        print(f"\nâŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: {e}")
        if conn:
            conn.rollback()
            
    finally:
        if cur:
            cur.close()
        if conn:
            conn.close()

if __name__ == "__main__":
    create_subway_table()



